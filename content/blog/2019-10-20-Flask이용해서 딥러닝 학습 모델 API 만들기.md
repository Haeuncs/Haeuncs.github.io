---
title: Flask이용해서 딥러닝 학습 모델 API 만들기
date: 2019-10-20 00:00:00
categories:
  - Python
  - Deep learning
tags:
  - Flask
  - tensorflow
---

# 나는 왜 Flask 를 사용했는가 ?

딥러닝으로 학습되어 생성된 h5 파일을 서버에 올려 동작하도록 했어야 했습니다.

하지만 개발을 할면서 내가 서버를 구축할 일이 없었고 API 를 사용했지 API 를 만들일은 없었지만 개인 프로젝트를 위해서 API 를 만들어야 했고 그래서 가장 친근한 언어인 Python을 사용하고 Flask 프레임워크를 사용해서 API 를 만들었습니다.

저와 같은 서버에 관한 지식이 1도 없는 분들을 위해서 작성해봤습니다 🙏

---

# 시작

Flask 의 예제 코드를 보면 Flask 가 쉽다는 것을 알 수 있습니다.

```Python
from flask import Flask
app = Flask(__name__)

@app.route("/")
def hello():
    return "Hello World!"

if __name__ == "__main__":
    app.run()

```

만약 post 로 보낸 body를 읽고 싶다면 아래와 같이 작성

```Python
@app.route('/', methods=['POST'])
def hello():
    if request.method == 'POST':
        review = request.form['text']
        return review
```

body 의 key 에 text를 넣고 value 에 원하는 값을 넣으면 그 값이 리턴될 것입니다.

# ![image1](/image/191020/image1.png)

# 딥러닝 h5 파일 실행하기

여기까지 잘 왔다면 50%는 해결되었습니다.

이제 딥러닝 모델 h5를 실행 시켜봅시다.

저는 여기서 시간이 오래걸렸는데 기존에 파이썬 코드로 h5 로 예측하는 방법를 사용하면 오류가 나면서 flask 실행이 중지되거나 오류가 나타났었습니다.

그래서 아래의 방식으로 h5 파일을 로드해야 합니다.

```Python
from keras.utils import CustomObjectScope
from keras.initializers import glorot_uniform
from tensorflow.python.keras.backend import set_session
from tensorflow.python.keras.models import load_model

with CustomObjectScope({'GlorotUniform': glorot_uniform()}):
    sess = tf.compat.v1.Session()
    set_session(sess)
    model = load_model('./모델이 저장된 path.h5')  # 저장된 모델 로딩
    model._make_predict_function()
    graph = tf.get_default_graph()


```

이렇게 모델을 부르고 서버로 데이터가 넘어올 때 전처리 -> 모델을 사용하여 예측하면 예측값이 제대로 옵니다.

data는 전처리된 값으로 모델을 실행시킬 input 값

```Python
@app.route('/', methods=['POST'])
def hello():
    if request.method == 'POST':
        value = request.form['text']
        data = value 를 전처리한 값
        global sess
        global graph
        with graph.as_default():
            set_session(sess)
            score = float(model.predict(data))
            return score

```

응답으로 예측된 값 리턴 됩니다 !\_!

# 서버에 Flask 올리기

이렇게 확인이 완료 되었으면 Amazon web service (AWS)에 서버를 생성해서 이 프로그램을 올려 봅시다.

#### 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥 이 때 주의할 점은 !! 🔥🔥🔥🔥🔥🔥🔥🔥🔥🔥

```Python
if __name__ == '__main__':
    app.run()

```

이 코드를

```Python
app.run(host="0.0.0.0")

```

으로 변경해줍니다.

host 를 설정해주지 않으면 로컬에서만 동작하기 때문에 외부에서 서버 IP 를 통해서 접속하려면 host 를 0.0.0.0으로 설정해야합니다.

서버를 시작하기 전에 필요한 라이브러리를 requirements.txt 으로 만들어서 현재 개발 환경을 세팅합니다.

터미널에

```Python
pip3 freeze > requirements.txt
```

를 치면 txt 파일이 생성됩니다.

https://aws.amazon.com/ko/

AWS 사이트에 접속하고 가입을 합시다.

AWS 를 사용하는 이유는 AWS 프리 티어로 1년동안 사용할 수 있는 클라우드를 제공하니 초보자들이 사용하기 좋습니다.

## 검색창에 EC2를 검색해서 아래와 같은 화면을 찾습니다.

![image2](/image/191020/image2.png)

## 우분투 서버를 선택합니다

![image3](/image/191020/image3.png)

단계 2부터 5까지 다음을 눌러주시고

## Flask 를 실행하는 포트 5000으로 접속하기 위해서 **단계 6 보안 그룹 구성**에 그림과 같이 **포트 5000번**을 할당

![image6](/image/191020/image6.png)

## 키페어

![image7](/image/191020/image7.png)

그리고 생성을 할 때 키페어 이름을 정하고 싶으신 것으로 정한 후 키 페어를 다운로드 하면 pem 포맷의 파일이 다운 받아집니다.

이 파일은 우리가 사용하는 로컬 터미널에서 원격 서버 터미널로 엑세스할 때 사용하기 때문에 위치를 꼭 기억합니다.

이렇게 되면 생성이 되었습니다.

![image11](/image/191020/image11.png)

콘솔에 들어가면 인스턴스에 방금 만든 것이 있을 텐데 **인스턴스 시작**을 눌러 실행을 시킨 후 **연결**을 눌러 **인스턴스 엑세스 방법**을 따르면 원격 서버에 접속이 됩니다. 접속이 되셨다면 원격 서버를 생성하는 단계가 끝났습니다 👏

## 아래부터는 인스턴스 콘솔 화면 아래에 설명에 있는 퍼블릭 DNS와 IPv4 퍼블릭 IP 를 알고 계셔야 합니다.

## ![image12](/image/191020/image12.png)

그럼 우리의 로컬에 있는 Flask 실행파일과 학습 모델과 이전에 만든 requirements.txt 을 **압축**하여 원격 서버로 전송해봅시다.

```
scp -i "pem포맷의 엑세스 파일 경로" "방금 압축한 파일 경로" ubuntu@여기에는 퍼블릭 DNS(IPv4) 를 적어줍니다.:여기에는 원격에 저장될 경로를 작성해줍니다.

```

아래 처럼 작성하면 됩니다.

```
scp -i serverKey.pem sentimentVer0.0.zip ubuntu@여기는퍼블릭:~/;

```

원격에 접속해서 확인해보면 제대로 파일이 전송된 것을 알 수 있습니다. Yeah~~

```
unzip zip파일
```

을 실행해서 전송한 zip 파일을 풀고 파이썬을 설치하고 requirements.txt 에 작성된 라이브러리를 설치하기 위해 아래와 같은 명령을 작성합니다.

```
pip3 install -r requirements.txt
```

이제 우리가 만든 flask 파이썬 파일을 실행하면 아래와 같이 실행될 것입니다 👏👏👏

![image9](/image/191020/image9.png)

이제 어느 기기에서나 AWS 콘솔에 IPv4 퍼블릭 IP ip 주소를 통해서 원격으로 접속할 수 있습니다.

postman 으로 원격 서버로 API를 요청한 결과! 제대로 작동합니다 👏👏👏👏👏👏👏👏👏

![image10](/image/191020/image10.png)

## Any question?🙋‍

코드에 문제가 있거나 어떤 질문이든 편하게 메일을 보내주세요!

Please email me with any questions or concerns! 😃<br/>
💌 : haeun.developer@gmail.com
